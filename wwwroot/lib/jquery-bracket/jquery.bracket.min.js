/**
 * Copyright (c) 2011-2017, Teijo Laine,
 * http://aropupu.fi/bracket-server/
 *
 * Released under the MIT License
 */
(function(f){"function"===typeof define&&define.amd?define(["jquery"],f):"object"===typeof exports?module.exports=f(require("jquery")):f(jQuery)})(function(f){function r(a,b){return a.originalEvent.changedTouches?a.originalEvent.changedTouches[0][b]:a[b]}function t(a,b,c){a.css("width",b).css("height",c)}function u(a,b,c){var d=f('<div class="jQBracket '+a+'"></div>').appendTo(b);d.append(c);return d}function p(a,b){var c=a.round,d=a.match,e=c.next?c.next().match(d.idx.round):null;d.first.id<d.second.id?d.first.id=a.team:d.second.id=a.team;c.match(d.idx.round).readonly=!0;e&&(c.dirty=!0,0===d.idx.match%2?(e.first.id=d.first.id,e.first.name=d.first.name,e.second.id=d.second.id,e.second.name=d.second.name):(e.second.id=d.first.id,e.second.name=d.first.name,e.first.id=d.second.id,e.first.name=d.second.name));return b}function q(a){var b=a.el,c=b.find(".team[data-teamid="+a.team+"]"),d=f('<div class="bubble">1st</div>').appendTo(c);b.find(".team").each(function(){var a=f(this);a.data("teamid")!==c.data("teamid")&&a.data("teamid")!==c.data("teamid")&&f('<div class="bubble">3rd</div>').appendTo(a)});d.click(function(){var b=a.final.element.find(".team.win");b.each(function(){var a=f(this).data("teamid");p({team:a,round:a.round,match:a.match},!1)});f(this).remove()})}function v(a){if(a){if(!a.name)return a.id;var b=f("<span></span>").text(a.name);b.data("id",a.id);return b}return null}function w(a){function b(a,d,e,k,n,h){var m=Math.log(2*d.length);n||(n=c(a,d,e,k,h));k.css(a,n*m+d.length*(e.height()+4)+"px");h.css(a,k.height()+"px")}function c(a,b,e,k,n){var h,m,l;h=b.height();if(!b.next().length)return h/2;h=c(a,b.next(),e,k,n);b=b.height()/2;h=h+b;b.next().length&&b.next().height()===b.height()&&(m=h-b,l=h+b,k.append('<div class="connector" style="height: '+(l-m)+"px; top: "+m+'px;"></div>'));return h}var d=f.extend(!0,{},a),e=v;if(d.decorator&&d.decorator.edit&&d.decorator.render)e=d.decorator.render;var k=f('<div class="bracket"></div>'),n=d.teams,h=d.results,m=[],l=f.isArray(n)&&f.isArray(n[0]),g;g=l?n.length:n.length/2;for(var x=0;x<g;x+=1)m.push(f('<div class="round"></div>').appendTo(k));if(l)for(g=0;g<n.length;g+=1)for(var y=0;y<n[g].length;y+=1){var z=e(n[g][y]);z.data("id",n[g][y]);z.data("teamname",n[g][y]);m[g].append(z)}else for(g=0;g.length;y+=2){var A=e(n[y]),B=e(n[y+1]);A.data("id",n[y]);B.data("id",n[y+1]);A.data("teamname",n[y]);B.data("teamname",n[y+1]);m[0].append(A).append(B)}for(g=0;g<h.length;g+=1)for(x=0;x<h[g].length;x+=1)for(y=0;y<h[g][x].length;y+=1){var C=h[g][x][y],D=m[x+1]?m[x+1].find("div:eq("+(y/2|0)+")"):null;if(null!==C[0]&&null!==C[1]){var E=m[x].find("div:eq("+(2*y)+")"),F=m[x].find("div:eq("+(2*y+1)+")");C[0]>C[1]?F.addClass("lose"):C[0]<C[1]&&E.addClass("lose");C[0]>C[1]?E.addClass("win"):C[0]<C[1]&&F.addClass("win");D&&D.html(C[0]>C[1]?E.html():F.html())}else D&&D.addClass("np");var G=e(""),H=e("");G.data("id",null);H.data("id",null);G.data("teamname",null);H.data("teamname",null);D&&D.data("id")?H.data("id",D.data("id")):G.data("id",D.data("id"));G.addClass("score");H.addClass("score");G.text(C[0]);H.text(C[1]);D=m[x].find("div:eq("+(2*y)+")");D.append(G);D=m[x].find("div:eq("+(2*y+1)+")");D.append(H)}b("width",m,d.matchMargin,k,d.teamWidth,d.el);return{el:d.el}}function s(a,b,c,d,e,k,n,h){var m=c.teams[d][0],l=c.teams[d][1];if(m.id===s.empty||l.id===s.empty)b.append('<div class="match np"></div>'),s.cont(a,b,c,d+1,e,k,n,h);else{var g=new s.Match(a,b,c,d,e,k,n,h);b.append(g.el)}}function A(a,b,c,d,e,k){var n=f.extend(!0,{},a),h=f.extend(!0,{},c);n.el=b;h.el=k;n.callbacks=d;n.render=e;b=new s.Layout(n);k=new s.Layout(h);s.Series(b.bracket,k.bracket,a,h,d);return{bracket:b,consolation:k}}s.empty=-1;s.Layout=function(a){function b(){var a=f('<div class="tools"></div>').appendTo(e.el);var c=f('<span>EDIT</span>').appendTo(a);c.click(function(){g.find("div.label").add("div.score").attr("contenteditable",!0);c.remove()});if(e.skipConsolation)a.remove();return e}var c=a.teamWidth,d=a.scoreWidth,g=a.el,e=a.init,k=a.vOffset,n=f('<div class="jQBracket"></div>');a.rtl&&(g=g.css("direction","rtl"));g.append(n);var h=b(),m=new s.Round(h,n,e,e.results.length-1,null,!0,a);m.render();g.css("height",m.el.height());a.dir==="rl"&&n.css("right",0);g.children().css(a.dir,0);return{bracket:n,final:m}};s.Series=function(a,b,c,d,g){function e(a){return function(b,c,e){var f;f=g.decorator.edit(b,c,e,a);p(f,!0);q({final:a.final,el:a.el,team:c.team})}}function k(a){return function(){a.el.find(".team").each(function(){f(this).unbind("click")})}}function n(a){return function(b){var c=b.data("teamid");b.siblings("div.label").attr("contenteditable",!0);b.parent().parent().data("readonly",!0);b.click(function(){var e=f(this).parent().data("matchid"),e=a.round.match(e);p({team:c,round:a.round,match:e},!0)})}}var h=a.find(".round:last .match:last"),m=b.find(".round:last .match:last"),l=f.extend(e(h),{round:h.data("roundid"),match:h.data("matchid")}),r=f.extend(e(m),{round:m.data("roundid"),match:m.data("matchid")});c.disableToolbar||h.find(".team").click(l);d.disableToolbar||m.find(".team").click(r);c.disableToolbar||g.team.click(n(h));d.disableToolbar||g.team.click(n(m));c.disableToolbar||h.find(".score").click(g.score.click(l));d.disableToolbar||m.find(".score").click(g.score.click(r));g.team=k(a);g.score=k(a);g.team=k(b);g.score=k(b)};s.Round=function(a,b,c,d,g,e,k){var n=f.extend(!0,{},k);n.vOffset=k.vOffset;n.roundMargin=k.roundMargin;var h=f('<div class="round"></div>');h.data("roundid",d);var m=c.teams.length;m=Math.log(2*m);f.isArray(c.teams[0])||(m-=1);n.isFirst=0===d;n.isLast=d===m-1;n.roundNumber=d+1;c.teams.length;f.isArray(c.teams[0])&&c.teams[d]?n.matchCount=c.teams[d].length:n.isFirst?n.matchCount=c.teams.length/2:n.matchCount=c.teams.length/(Math.pow(2,d+1)/2);n.matchHeight=c.teams.length*k.matchHeight/n.matchCount;h.appendTo(b);g&&g.el.after(h);n.el=h;n.roundid=d;n.data=c;n.previousRound=g;n.nextRound=null;this.el=h;this.id=d;this.matches=[];this.render=function(){this.el.css("margin-right",n.roundMargin);this.el.css("margin-left",n.roundMargin);for(var a=0;a<n.matchCount;a+=1)this.matches.push(new s.Match(this,f('<div class="match-wrapper"></div>'),c,a,d,e,k));this.matches[this.matches.length-1].el.css("margin-bottom",0);!1===e&&(g=new s.Round(a,b,c,d-1,this,e,k),g.render(),this.previousRound=g,this.matches[0].el.before(g.el))};this.match=function(a){return this.matches[a]};this.data=function(){return c};e&&!n.isLast&&(g=new s.Round(a,b,c,d+1,this,e,k),g.render(),this.nextRound=g,this.matches[this.matches.length-1].el.after(g.el))};s.Match=function(a,b,c,d,e,k,n){function h(c){var d=c.data("teamid"),e=a.match(c.parent().data("matchid")),f=n.onMatchClick;if(f)f({round:a.id,match:e.idx.round,team:d,a:c,b:e});var g={team:d,round:a,match:e,result:p,score:l};(d=n.decorator.edit(g,n.init.teams[g.match.idx.round][g.match.idx.match],g.result,g.score,n))&&p(d,!0)}function m(c){var d=c.data("teamid"),e=a.match(c.parent().data("matchid")),f={team:d,round:a,match:e,score:l};var d=n.decorator.render(f,n.init.teams[f.match.idx.round][f.match.idx.match]),g=n.onMatchHover;if(g)g({round:a.id,match:e.idx.round,team:d,a:c,b:e})}function l(c){var d,e=n.init,f=a.data(),g=a.id,h=b.data("matchid"),l=f.results[g-1][h];d=c?l[0]:l[1];return d}var p=f.extend(!0,{},s.result),q=f('<div class="match" id="matchid-'+d+'"></div>'),r=f('<div class="team"></div>'),u=f('<div class="team"></div>');b.data("matchid",d);var t=c.teams[e][d];p.first.name=t[0];p.second.name=t[1];p.first.id=0;p.second.id=1;this.el=b;this.round=a;this.idx={round:d,match:e};k&&(t=r.clone(),u=r.clone(),p.first.el=t.appendTo(q),p.second.el=u.appendTo(q));k&&(p.first.score=f('<div class="score" contenteditable="true"></div>'),p.second.score=f('<div class="score" contenteditable="true"></div>'));k=c.results[e][d];k||(k=p);var w,x;f.isNumeric(k[0])&&f.isNumeric(k[1])?(w=f('<div class="label" contenteditable="true"></div>').appendTo(r),x=f('<div class="label" contenteditable="true"></div>').appendTo(u),w.append(p.first.name),x.append(p.second.name),p.first.score.text(k[0]),p.second.score.text(k[1]),r.append(p.first.score),u.append(p.second.score)):(w=f('<div class="label" contenteditable="true">'+p.first.name+"</div>"),x=f('<div class="label" contenteditable="true">'+p.second.name+"</div>"),r.append(w),u.append(x),f.isNumeric(k[0])?(k[0]>k[1]?r.addClass("win"):u.addClass("win"),w=f('<div class="score">'+k[0]+"</div>"),x=f('<div class="score">'+k[1]+"</div>"),r.append(w),u.append(x)):(r.addClass("np"),u.addClass("np")));q.appendTo(b);p.first.el=r;p.second.el=u;r.data("teamid",p.first.id);u.data("teamid",p.second.id);r.data("matchid",d);u.data("matchid",d);n.decorator.render(p,c,d);this.el.css("height",n.matchHeight);var y=this.el.height()-r.height()-u.height();this.el.css("margin-top",y/2);this.el.css("margin-bottom",y/2);if(a.nextRound){var z=f('<div class="connector"></div>').appendTo(r);z.css("height",y/2);z.css("top",-y/2-2);d%2===0&&a.nextRound.match(d/2).el.css("top",this.el.position().top+this.el.height()/2+"px")}var A=this.el.height()-this.el.height()/2;r.css("top",A+"px");u.css("bottom",A+"px");if(!n.disableToolbar){var B=r.find("div.label"),C=u.find("div.label");B.click(function(){h(f(this))});C.click(function(){h(f(this))});B.hover(function(){m(f(this))},function(){});C.hover(function(){m(f(this))},function(){})}if(n.onMatchResult){var D=function(c){var d=b.data("matchid"),d=a.round.match(d);if(f.isFunction(n.onMatchResult))n.onMatchResult(d,c,!0)};r.find(".score").change(function(){var a=parseInt(f(this).text());isNaN(a)||(p.first.score=a,D(p))});u.find(".score").change(function(){var a=parseInt(f(this).text());isNaN(a)||(p.second.score=a,D(p))})}this.result=function(){return p};this.data=function(){return c}};s.cont=function(a,b,c,d,e,k,n,h){var m=c.teams.length;m=Math.log(2*m);e&&e(b,d>m-2);d<m&&s(a,b,c,d,e,k,n,h)};s.result={first:{name:null,id:null,score:null,el:null},second:{name:null,id:null,score:null,el:null}};var B=function(){function a(){}a.prototype.init=function(a){var d=f.extend(!0,{},a);this.opts=d;var e=f.extend(!0,{},C);d.decorator&&(e=f.extend(!0,e,d.decorator));a=f('<div class="jQBracket '+this.opts.dir+'"></div>').appendTo(d.el);var k=u("bracket",a,this.opts.init.teams,this.opts.init.results,this.opts.decorator),n=null;d.skipConsolation||(n=u("consolation",a,this.opts.init.teams,this.opts.init.results,this.opts.decorator));k.css("float",this.opts.dir);n&&n.css("float",this.opts.dir);t(a,d.el.width(),k.height());this.bracket=k;this.consolation=n};a.prototype.data=function(){return this.opts.init};a.prototype.results=function(){var a=[],d=this.opts.init.results;return function(){for(var c=0;c<d.length;c+=1)for(var e=0;e<d[c].length;e+=1)a.push(d[c][e]);return a}()};a.prototype.addRound=function(){var a=this.results(),d=this.opts.init.results;0<a[a.length-1].length&&d.push([[]]);return this};a.prototype.dropRound=function(){this.opts.init.results.pop();return this};return a}(),C={};f.fn.bracket=function(a){var b,c,d,e,k,n,h,m,l,g,r,u,p;g=this;var t=function(){function q(a){var b,c;c=f(a.target);var g=c.attr("contenteditable");return b={target:c,val:c.text(),isUneditable:g?!1:!0,team:parseInt(c.parent().data("teamid")),round:a.data.round.id,match:a.data.match,game:e(c)}}var s=f.extend(!0,{},a);a=s.init.teams.length;s.el=this;s.teamWidth=s.teamWidth||70;s.scoreWidth=s.scoreWidth||20;s.matchMargin=s.matchMargin||10;s.roundMargin=s.roundMargin||40;s.vOffset=s.vOffset||s.matchMargin/2;s.isFirst=null;s.isLast=null;s.roundCount=null;s.matchCount=null;s.matchHeight=null;"lr"!==s.dir&&"rl"!==s.dir&&(s.dir="lr");s.centerConnectors&&!s.skipSecondaryFinal&&(s.skipSecondaryFinal=!0);f.isFunction(s.decorator)||(s.decorator={});h=s.el.find(".jQBracket");0===h.length?s.skipConsolation?b=w(s):s.rtl?d=new B:c=new s.Layout(s):console.log("Already initialized");var v=function(a){if(f.isFunction(s.onEdit))s.onEdit(q(a));else{var b=q(a);b.val?b.target.text(b.val):console.log("no value")}},x=function(a){if(f.isFunction(s.onRender))s.onRender(q(a))},y=function(a){var b,c;a=parseInt(f(this).data("teamid"));b=parseInt(f(this).parent().data("matchid"));c=e(f(this));if(f.isFunction(s.onMatchClick))s.onMatchClick({team:a,match:b,round:c})},z=function(a){var b,c;a=parseInt(f(this).data("teamid"));b=parseInt(f(this).parent().data("matchid"));c=e(f(this));if(f.isFunction(s.onMatchHover))s.onMatchHover({team:a,match:b,round:c})};e=function(a){return a.parents(".jQBracket").attr("class").replace("jQBracket","").trim()};k=function(){var a,b,c;a=f(this);b=parseInt(r(a.event, "pageX"));c=parseInt(r(a.event, "pageY"));f(document).bind("mousemove.bracket",function(d){a.css({top:d.pageY-c,left:d.pageX-b})});return f(document).bind("mouseup.bracket",function(a){f(this).unbind("mousemove.bracket").unbind("mouseup.bracket");return!1})};n=function(a){var b=a.find(".team");b.find(".label").unbind("dblclick.bracket",v).bind("dblclick.bracket",v);b.find(".label").unbind("blur.bracket",v).bind("blur.bracket",v);b.find(".label").unbind("mouseenter.bracket",x).bind("mouseenter.bracket",x);b.unbind("click.bracket",y).bind("click.bracket",y);b.unbind("mouseenter.bracket",z).bind("mouseenter.bracket",z).unbind("mouseleave.bracket",function(){});b.find(".score").unbind("blur.bracket",v).bind("blur.bracket",v);b.find(".score").each(function(){var a=f(this);a.data("original",a.text())});b.find(".score").unbind("keyup.bracket",function(a){9.0===a.keyCode&&f(this).blur()}).bind("keyup.bracket",function(a){9.0===a.keyCode&&f(this).blur()});b.find(".score").unbind("blur.bracket",function(){var a=f(this);a.text()!==a.data("original")&&a.change()}).bind("blur.bracket",function(){var a=f(this);a.text()!==a.data("original")&&a.change()});b.filter(function(){return 0<f(this).parents(".jQBracket > .bracket").length}).find(".tools span").click(function(){var a=f(this).parent().parent().parent();b=a.clone(!1);a.remove();m.init(b.bracket(s));n(m.bracket)});return b.find(".team").mousedown(k)};var t={init:function(a){t.options=f.extend({},t.defaults,a);t.options.el=g;s.skipConsolation?b=w(t.options):(c=new s.Layout(t.options),s.disableToolbar||n(c.bracket));return c},defaults:{init:{teams:[],results:[]},teamWidth:100,scoreWidth:30,matchMargin:20,roundMargin:40,dir:"lr",onMatchClick:null,onMatchHover:null,onRender:null,onEdit:null,decorator:null,skipConsolation:!1,disableToolbar:!1},render:function(){var a=f.extend(!0,{},t.options);a.el=f(this);b=w(a);return f(this)},data:function(){return b?b.data():c.data()}};if("object"===typeof a||!a)return t.init.apply(this,arguments);if(t[a])return t[a].apply(f(this),Array.prototype.slice.call(arguments,1));f.error("Method "+a+" does not exist on jQuery.bracket")}}); 